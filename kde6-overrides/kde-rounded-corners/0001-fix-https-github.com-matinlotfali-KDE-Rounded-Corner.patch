From 5fe79555c4e2a7613d699fb6a50795db23c4334d Mon Sep 17 00:00:00 2001
From: GloriousEggroll <gloriouseggroll@gmail.com>
Date: Mon, 25 Mar 2024 13:01:11 -0600
Subject: [PATCH] fix
 https://github.com/matinlotfali/KDE-Rounded-Corners/issues/175

---
 src/shaders/shapecorners.frag | 10 ++++++++--
 src/shaders/shapecorners_core.frag | 5 ++++-
 2 files changed, 12 insertions(+), 3 deletions(-)

diff --git a/src/shaders/shapecorners.frag b/src/shaders/shapecorners.frag
index 67b7723..d1e03e8 100644
--- a/src/shaders/shapecorners.frag
+++ b/src/shaders/shapecorners.frag
@@ -1,4 +1,5 @@
 #version 110
+#include "colormanagement.glsl"
 
 uniform sampler2D front;         // The painted contents of the window.
 uniform float radius;            // The thickness of the outline in pixels specified in settings.
@@ -110,7 +111,9 @@ void main(void)
 {
     vec4 tex = texture2D(front, texcoord0);  // The RGBA of the XY pixel for the painted window
     if(tex.a == 0.0) {
-        gl_FragColor = tex;
+        // Apply the HDR color management only if running in Plasma 6.
+        tex = sourceEncodingToNitsInDestinationColorspace(tex);
+        gl_FragColor = nitsToDestinationEncoding(tex);
         return;
     }
 
@@ -163,6 +166,9 @@ void main(void)
     }
     tex *= modulation;
 
+    // Apply the HDR color management only if running in Plasma 6.
+    tex = sourceEncodingToNitsInDestinationColorspace(tex);
+
     // Send to output
-    gl_FragColor = tex;
+    gl_FragColor = nitsToDestinationEncoding(tex);
 }
diff --git a/src/shaders/shapecorners_core.frag b/src/shaders/shapecorners_core.frag
index 6abc1af..309a064 100644
--- a/src/shaders/shapecorners_core.frag
+++ b/src/shaders/shapecorners_core.frag
@@ -1,5 +1,7 @@
 #version 140

+#include "colormanagement.glsl"
+
 uniform sampler2D front;         // The painted contents of the window.
 uniform float radius;            // The thickness of the outline in pixels specified in settings.
 uniform vec2 windowSize;         // Containing `window->frameGeometry().size()`
@@ -163,5 +165,6 @@ void main(void)
     tex *= modulation;

     // Send to output
-    fragColor = tex;
+    tex = sourceEncodingToNitsInDestinationColorspace(tex);
+    fragColor = nitsToDestinationEncoding(tex);
 }
-- 
2.44.0

